<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æ•¸çš„æ¯”å¤§å° PK æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Tone.js åº« for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* è¨­å®šä¸»è¦å­—é«”ç‚º Inter (é€šç”¨ä¸”æ˜“è®€) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7ffee; /* æ·ºé»ƒç¶ è‰²èƒŒæ™¯, é©åˆå­¸ç¿’ */
        }
        /* å®šç¾©åˆ†æ•¸é¡¯ç¤ºæ¨£å¼ */
        .fraction-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem; /* å¤§å­—é«” */
            font-weight: 700;
            line-height: 1; /* èª¿æ•´è¡Œé«˜è®“åˆ†å­åˆ†æ¯é è¿‘ */
            margin: 0 1rem;
            color: #333;
        }
        .fraction-separator {
            width: 100%;
            height: 4px; /* æ‰å¹³çš„åˆ†éš”ç·š */
            background-color: #333;
            margin: 2px 0; /* å¾®èª¿ä¸Šä¸‹é–“è· */
        }
        .numerator {
            padding-bottom: 5px; /* çµ¦åˆ†å­ä¸€é»ç©ºé–“ */
        }
        .denominator {
            padding-top: 5px; /* çµ¦åˆ†æ¯ä¸€é»ç©ºé–“ */
        }
        
        /* ç©å®¶è³‡è¨Šæ°´å¹³é¡¯ç¤ºåœ¨å·¦ä¸Š/å³ä¸Š */
        .player-info {
            white-space: nowrap;
            position: absolute;
            top: 1rem; /* è·é›¢é ‚éƒ¨ 1rem */
            font-size: 1.5rem;
            font-weight: bold;
            padding: 0.5rem 1rem; /* å¢åŠ æ°´å¹³ padding */
            background: rgba(255, 255, 255, 0.9); /* æ›´å¯¦å¿ƒçš„èƒŒæ™¯ */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* æ›´æ˜é¡¯çš„é™°å½± */
            z-index: 10; /* ç¢ºä¿åˆ†æ•¸åœ¨æœ€ä¸Šå±¤ */
            transform: none !important; /* ç§»é™¤æ‰€æœ‰æ—‹è½‰ */
        }
        #p1-score-display {
            left: 1rem; 
        }
        #p2-score-display {
            right: 1rem;
        }

        /* ç¢ºä¿æŒ‰éˆ•æœ‰è¶³å¤ çš„è§¸æ§é¢ç© */
        .symbol-btn {
            min-height: 48px; /* æœ€å°è§¸æ§ç›®æ¨™å°ºå¯¸ */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ç©å®¶ä¸€è³‡è¨Š (å·¦ä¸Šè§’) -->
    <div id="p1-score-display" class="player-info text-blue-600 border-b-2 border-blue-400 hidden">
        ç©å®¶ä¸€: 0 åˆ†
    </div>

    <!-- ç©å®¶äºŒè³‡è¨Š (å³ä¸Šè§’) -->
    <div id="p2-score-display" class="player-info text-red-600 border-b-2 border-red-400 hidden">
        ç©å®¶äºŒ: 0 åˆ†
    </div>

    <div id="app" class="bg-white rounded-2xl shadow-2xl p-6 md:p-10 w-full max-w-4xl text-center border-4 border-lime-600 relative">
        <!-- å…§å®¹å°‡ç”± JavaScript å‹•æ…‹æ’å…¥ -->
    </div>


    <script type="text/javascript">
        // æ‡‰ç”¨ç¨‹å¼ ID å’Œ Firebase é…ç½® (å³ä½¿ä¸ä½¿ç”¨ Firestore ä¹Ÿè¦åŒ…å«é€™äº›è®Šæ•¸ä»¥ä¿æŒä»£ç¢¼ä¸€è‡´æ€§)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // FIX: å¿…é ˆä½¿ç”¨å…¨åŸŸè®Šæ•¸ __initial_auth_tokenï¼Œè€Œä¸æ˜¯æ­£åœ¨å®£å‘Šçš„è®Šæ•¸ initialAuthToken
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        // ----------------------------------------------------
        // æ ¸å¿ƒéŠæˆ²é‚è¼¯
        // ----------------------------------------------------

        const appElement = document.getElementById('app');
        let currentQuestionIndex = 0;
        let isAnswerLocked = false; // é–å®šï¼šè¡¨ç¤ºæœ¬å›åˆå·²çµæŸ
        let roundTimeout = null; // ç”¨æ–¼è™•ç†åŒæ™‚ç­”é¡Œçš„ç·©è¡è¨ˆæ™‚å™¨

        // è¿½è¹¤ç•¶å‰å›åˆçš„ç‹€æ…‹ï¼Œç”¨æ–¼ç®¡ç†æ‡²ç½°æ©Ÿåˆ¶èˆ‡è¨ˆåˆ†
        let currentQuestionState = {
            p1_disabled: false,     // ç©å®¶ä¸€æ˜¯å¦å·²è¢«ç¦ç”¨ (ç­”éŒ¯)
            p2_disabled: false,     // ç©å®¶äºŒæ˜¯å¦å·²è¢«ç¦ç”¨ (ç­”éŒ¯)
            correct_attempts: 0,    // æ­£ç¢ºå›ç­”æ¬¡æ•¸ (æœ€å¤š 2 æ¬¡)
            first_winner: null,     // ç¬¬ä¸€å€‹æ­£ç¢ºå›ç­”çš„ç©å®¶ (1 æˆ– 2)
        };

        let player1Score = 0;
        let player2Score = 0;
        let questions = []; // å„²å­˜éš¨æ©Ÿç”Ÿæˆçš„é¡Œç›®

        // Tone.js Sound Logic
        let correctSynth = null;
        let wrongSynth = null;

        /**
         * åˆå§‹åŒ– Tone.js åˆæˆå™¨
         */
        function setupFeedbackSynths() {
            if (correctSynth) return; // å·²è¨­å®š

            correctSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: { attack: 0.05, decay: 0.2, sustain: 0.1, release: 0.5 }
            }).toDestination();

            wrongSynth = new Tone.Synth({
                oscillator: { type: "square" }, 
                envelope: { attack: 0.005, decay: 0.5, sustain: 0.0, release: 0.1 }
            }).toDestination();
        }

        /**
         * æ’­æ”¾ç­”å°éŸ³æ•ˆï¼šæ­¡å¿«çš„ C Major ç¶éŸ³ï¼Œæ¨¡æ“¬æ…¶ç¥
         */
        async function playCorrectSound() {
            await Tone.start();
            setupFeedbackSynths();
            
            const now = Tone.now();
            correctSynth.triggerAttackRelease(["C5", "E5", "G5"], "8n", now);
            correctSynth.triggerAttackRelease(["G5", "C6"], "8n", now + 0.2);
        }

        /**
         * æ’­æ”¾ç­”éŒ¯éŸ³æ•ˆï¼šå¿«é€Ÿä¸‹é™çš„éŸ³ç¬¦ï¼Œæ¨¡æ“¬éŒ¯èª¤/æ²®å–ªçš„è²éŸ³ (Buzzer)
         */
        async function playWrongSound() {
            await Tone.start();
            setupFeedbackSynths();

            const now = Tone.now();
            wrongSynth.triggerAttackRelease("C3", "32n", now);
            wrongSynth.triggerAttackRelease("B2", "32n", now + 0.05);
            wrongSynth.triggerAttackRelease("A#2", "32n", now + 0.1);
        }

        /**
         * éš¨æ©Ÿæ‰“äº‚é™£åˆ—é †åº (Fisher-Yates Shuffle)
         * @param {Array} array è¦æ‰“äº‚çš„é™£åˆ—
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                // ä½¿ç”¨æ­£ç¢ºçš„é™£åˆ—è§£æ§‹è³¦å€¼ä¾†äº¤æ›å…ƒç´ 
                [array[i], array[j]] = [array[j], array[i]]; 
            }
            return array;
        }


        /**
         * éš¨æ©Ÿç”Ÿæˆä¸€å€‹åŒåˆ†æ¯åˆ†æ•¸æ¯”è¼ƒé¡Œç›®
         * @param {number} d æŒ‡å®šåˆ†æ¯ (è‹¥ç‚º null å‰‡éš¨æ©Ÿ)
         * @returns {object} åŒ…å« n1, d1, n2, d2, answer çš„ç‰©ä»¶
         */
        function generateRandomFractions(d = null) {
            // å¦‚æœæœªæŒ‡å®šåˆ†æ¯ï¼Œå‰‡é¸æ“‡åˆ†æ¯ (é™åˆ¶åœ¨ 2 åˆ° 12 ä¹‹é–“)
            if (d === null) {
                 const possibleDenominators = [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
                 d = possibleDenominators[Math.floor(Math.random() * possibleDenominators.length)];
            }
           

            // é¸æ“‡åˆ†å­ (n1, n2)
            let n1, n2;
            let isSame = false;
            do {
                // åˆ†å­ç¯„åœï¼š1 åˆ° d-1
                n1 = Math.floor(Math.random() * (d - 1)) + 1;
                n2 = Math.floor(Math.random() * (d - 1)) + 1;
                
                // æ¸›å°‘ç”Ÿæˆç›¸åŒåˆ†å­çš„æ©Ÿç‡ (80% æ©Ÿç‡é‡è©¦)
                isSame = (n1 === n2);
            } while (isSame && Math.random() < 0.8);

            // ç¢ºå®šç­”æ¡ˆ
            let answer;
            if (n1 > n2) {
                answer = '>';
            } else if (n1 < n2) {
                answer = '<';
            } else {
                answer = '=';
            }

            return { n1, d1: d, n2, d2: d, answer };
        }

        /**
         * ç”Ÿæˆå®Œæ•´çš„é¡Œç›®åˆ—è¡¨ (3 è¦–è¦ºé¡Œ + 5 æ•¸å­—é¡Œ = 8 é¡Œ)
         */
        function generateAllQuestions() {
            
            const visualCount = 3;     // 3 é¡Œè¦–è¦ºåœ–å½¢é¡Œ
            const numericCount = 5;    // 5 é¡Œæ•¸å­—åˆ†æ•¸é¡Œ
            
            let allQuestions = [];
            let idCounter = 1;

            // --- 1. ç”Ÿæˆè¦–è¦ºé¡Œ (å¼·åˆ¶æŒ‡å®šå½¢å¼) ---
            
            // 1.1 ç¬¬ä¸€é¡Œ: é•·æ–¹å½¢ (Bar Model)
            let q1Data = generateRandomFractions();
            allQuestions.push({
                ...q1Data,
                type: 'visual',
                modelType: 'bar',
                title: `ç¬¬ ${idCounter++} é¡Œ (åœ–å½¢æ¯”è¼ƒ - é•·æ–¹å½¢)`
            });

            // 1.2 ç¬¬äºŒé¡Œ: åœ“å½¢ (Circle Model)
            let q2Data = generateRandomFractions();
             allQuestions.push({
                ...q2Data,
                type: 'visual',
                modelType: 'circle',
                title: `ç¬¬ ${idCounter++} é¡Œ (åœ–å½¢æ¯”è¼ƒ - åœ“å½¢)`
            });

            // 1.3 ç¬¬ä¸‰é¡Œ: æ­£æ–¹å½¢ (Square Model) ä¸”åˆ†æ¯ç‚º 4
            let q3Data = generateRandomFractions(4); // æŒ‡å®šåˆ†æ¯ç‚º 4
            allQuestions.push({
                ...q3Data,
                type: 'visual',
                modelType: 'square',
                title: `ç¬¬ ${idCounter++} é¡Œ (åœ–å½¢æ¯”è¼ƒ - æ­£æ–¹å½¢ (1/4))`,
            });
            
            
            // --- 2. ç”Ÿæˆæ•¸å­—é¡Œ (5 é¡Œï¼Œéš¨æ©Ÿåˆ†æ¯) ---
            let numericQuestions = [];
            for (let i = 0; i < numericCount; i++) {
                let qData = generateRandomFractions();
                numericQuestions.push({
                    ...qData,
                    type: 'numeric',
                    modelType: null,
                });
            }
            
            // æ•¸å­—é¡Œå…§éƒ¨éš¨æ©Ÿæ‰“äº‚é †åº
            shuffleArray(numericQuestions);
            
            // åˆä½µåˆ°ç¸½åˆ—è¡¨
            allQuestions = allQuestions.concat(numericQuestions);

            // 3. é‡æ–°ç·¨è™Ÿå’Œè¨­å®šæ¨™é¡Œ (å¾ç¬¬ 4 é¡Œé–‹å§‹)
            for (let i = visualCount; i < allQuestions.length; i++) {
                const q = allQuestions[i];
                q.title = `ç¬¬ ${idCounter++} é¡Œ (æ•¸å­—æ¯”è¼ƒ)`;
            }

            return allQuestions;
        }

        /**
         * å‰µå»ºè‡ªè¨‚åˆ†æ•¸é¡¯ç¤ºæ ¼å¼çš„ HTML çµæ§‹
         * @param {number} n åˆ†å­ (Numerator)
         * @param {number} d åˆ†æ¯ (Denominator)
         * @returns {string} HTML å­—ä¸²
         */
        function createFractionHTML(n, d) {
            return `
                <div class="fraction-display w-20">
                    <div class="numerator">${n}</div>
                    <div class="fraction-separator"></div>
                    <div class="denominator">${d}</div>
                </div>
            `;
        }

        /**
         * å‰µå»ºé•·æ–¹å½¢åœ–å½¢è¡¨ç¤º (Bar Model)
         * @param {number} n åˆ†å­
         * @param {number} d åˆ†æ¯
         * @returns {HTMLElement} è¦–è¦ºåŒ–å…ƒç´ 
         */
        function createBarModel(n, d) {
            const container = document.createElement('div');
            container.className = 'flex w-40 h-8 border-2 border-gray-400 rounded-lg overflow-hidden shadow-md mx-auto my-1';

            for (let i = 0; i < d; i++) {
                const segment = document.createElement('div');
                segment.className = `flex-1 h-full ${i < n ? 'bg-indigo-400' : 'bg-gray-200'}`;
                if (i < d - 1) {
                    segment.style.borderRight = '1px solid #aaa';
                }
                container.appendChild(segment);
            }
            return container;
        }

        /**
         * å‰µå»ºåœ“å½¢åœ–å½¢è¡¨ç¤º (Circle Model/é¤…åœ– - ä½¿ç”¨ conic-gradient)
         * @param {number} n åˆ†å­
         * @param {number} d åˆ†æ¯
         * @returns {HTMLElement} è¦–è¦ºåŒ–å…ƒç´ 
         */
        function createCircleModel(n, d) {
            const container = document.createElement('div');
            container.className = 'w-20 h-20 rounded-full border-2 border-gray-400 shadow-md mx-auto my-1 relative overflow-hidden flex items-center justify-center';

            const fillPercentage = (n / d) * 100;
            
            container.style.background = `conic-gradient(
                #4f46e5 0% ${fillPercentage}%,
                #e5e7eb ${fillPercentage}% 100%
            )`;

            return container;
        }

        /**
         * å‰µå»ºæ–¹å½¢åœ–å½¢è¡¨ç¤º (Square Model - ä½¿ç”¨ CSS Grid)
         * @param {number} n åˆ†å­
         * @param {number} d åˆ†æ¯
         * @returns {HTMLElement} è¦–è¦ºåŒ–å…ƒç´ 
         */
        function createSquareModel(n, d) {
            const squareContainer = document.createElement('div');
            squareContainer.className = 'w-20 h-20 border-2 border-gray-400 rounded-lg shadow-md mx-auto my-1 overflow-hidden';
            
            let cols = 1;
            // ç›¡å¯èƒ½ä½¿ç”¨ç¶²æ ¼ä¾†åˆ†å‰²è¦–è¦ºåœ–å½¢ (ç‰¹åˆ¥ç‚º d=4, d=9, d=12 ç­‰è¨­è¨ˆ)
            if (d === 4) cols = 2; 
            else if (d === 9) cols = 3; 
            else if (d === 12) cols = 4; 
            else if (d === 10) cols = 5; 
            else if (d === 8) cols = 4; 

            const rows = Math.ceil(d / cols);
            
            if (cols > 1 && d % cols === 0 && d !== 7 && d !== 11) { // é¿å…ä¸èƒ½å®Œç¾ç¶²æ ¼çš„æ•¸å­—
                squareContainer.classList.add('grid');
                squareContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                squareContainer.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

                for (let i = 0; i < d; i++) {
                    const segment = document.createElement('div');
                    
                    let classes = `h-full w-full ${i < n ? 'bg-indigo-400' : 'bg-gray-200'}`;
                    
                    // å¢åŠ é‚Šç•Œç·šä»¥å€åˆ†ç¶²æ ¼
                    if (Math.floor(i / cols) < (rows - 1)) classes += ' border-b border-gray-400';
                    if (i % cols < (cols - 1)) classes += ' border-r border-gray-400';

                    segment.className = classes;
                    squareContainer.appendChild(segment);
                }
            } else {
                // å°æ–¼ä¸èƒ½å®Œç¾ç¶²æ ¼åŒ–çš„åˆ†æ¯ï¼Œé€€å›åˆ°é•·æ¢åˆ†å‰²æ¨¡å¼
                 squareContainer.classList.add('flex');
                 for (let i = 0; i < d; i++) {
                     const segment = document.createElement('div');
                     segment.className = `flex-1 h-full ${i < n ? 'bg-indigo-400' : 'bg-gray-200'}`;
                     if (i < d - 1) {
                         segment.style.borderRight = '1px solid #aaa';
                     }
                     squareContainer.appendChild(segment);
                 }
            }
            return squareContainer;
        }

        /**
         * å‰µå»ºè¦–è¦ºæ¨¡å‹çš„åˆ†ç™¼å™¨ (Dispatcher)
         * @param {string} type æ¨¡å‹é¡å‹ ('bar', 'circle', 'square')
         * @param {number} n åˆ†å­
         * @param {number} d åˆ†æ¯
         * @returns {HTMLElement} è¦–è¦ºåŒ–å…ƒç´ 
         */
        function createVisualModel(type, n, d) {
            switch (type) {
                case 'bar':
                    return createBarModel(n, d);
                case 'circle':
                    return createCircleModel(n, d);
                case 'square':
                    return createSquareModel(n, d);
                default:
                    return createBarModel(n, d); // é è¨­ä½¿ç”¨é•·æ¢åœ–
            }
        }

        /**
         * æ›´æ–°åˆ†æ•¸é¡¯ç¤º
         */
        function updateScoreDisplay() {
            const p1Display = document.getElementById('p1-score-display');
            const p2Display = document.getElementById('p2-score-display');

            if (p1Display) {
                p1Display.textContent = `ç©å®¶ä¸€: ${player1Score} åˆ†`;
            }
            if (p2Display) {
                p2Display.textContent = `ç©å®¶äºŒ: ${player2Score} åˆ†`;
            }
        }
        
        /**
         * Helper function to disable all buttons of a specific player
         * @param {number} player 1 or 2
         */
        function disablePlayerButtons(player) {
            const buttons = document.querySelectorAll(`#p${player}-controls .symbol-btn`);
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                // ç§»é™¤ active color classes
                btn.classList.remove(`active:bg-${player === 1 ? 'blue' : 'red'}-600`);
            });
        }

        /**
         * Helper function to disable all control buttons on the screen
         */
        function disableAllControlButtons() {
            const allButtons = document.querySelectorAll(`.symbol-btn`);
            allButtons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                // ç§»é™¤ active color classes and ensure all color variations are cleaned
                btn.classList.remove('active:bg-blue-600', 'active:bg-red-600', 'bg-red-700', 'bg-blue-400', 'bg-red-400');
                btn.classList.add('bg-gray-400'); // çµ±ä¸€ç½®ç°
            });
        }

        /**
         * çµæŸå›åˆï¼Œè™•ç†è¨ˆåˆ†ã€é¡¯ç¤ºçµæœå’Œé–å®š UI
         * @param {string} mode çµæŸæ¨¡å¼: 'single_winner', 'simultaneous', 'double_fault'
         */
        function finalizeRound(mode) {
            if (roundTimeout) {
                clearTimeout(roundTimeout);
                roundTimeout = null;
            }

            if (isAnswerLocked) return; // é¿å…é‡è¤‡çµæŸå›åˆ
            isAnswerLocked = true;
            disableAllControlButtons(); // é–å®šæ‰€æœ‰æŒ‰éˆ•
            
            const q = questions[currentQuestionIndex];
            const feedbackArea = document.getElementById('feedback-area');
            const resultSymbol = document.getElementById('result-symbol');

            // é¡¯ç¤ºæ­£ç¢ºçš„æ¯”è¼ƒç¬¦è™Ÿ
            resultSymbol.textContent = q.answer;
            resultSymbol.classList.remove('text-gray-500');

            let message = "";
            let symbolClass = "";
            let timeoutDuration = 1500;

            switch (mode) {
                case 'simultaneous':
                    // é›™äººæ­£ç¢ºé‚è¼¯
                    player1Score++;
                    player2Score++;
                    message = "å…©ç©å®¶éƒ½å¾ˆå²å®³ï¼Œå¾ˆäº†è§£æ¦‚å¿µï¼Œå›ç­”é€Ÿåº¦ä¹Ÿå¾ˆå¿«å–”ï¼";
                    symbolClass = "bg-green-100 text-green-600 border-green-600";
                    timeoutDuration = 2000;
                    break;

                case 'single_winner':
                    // å–®äººå‹å‡ºé‚è¼¯
                    const winner = currentQuestionState.first_winner;
                    if (winner === 1) {
                        player1Score++;
                        message = "ğŸ‰ ç©å®¶ä¸€ç­”å°äº†ï¼";
                    } else {
                        player2Score++;
                        message = "ğŸ‰ ç©å®¶äºŒç­”å°äº†ï¼";
                    }
                    symbolClass = "bg-green-100 text-green-600 border-green-600";
                    break;
                
                case 'double_fault':
                    // é›™äººéŒ¯èª¤é‚è¼¯ (å·²åœ¨ checkAnswer ä¸­è™•ç†å®Œç¦ç”¨)
                    message = `ä¸‹æ¬¡è¦å†·éœã€ä»”ç´°çœ‹é¡Œç›®ï¼Œé€™é¡Œç­”æ¡ˆæ˜¯ <span class="font-extrabold"> ${q.answer} </span> å–”ï¼`;
                    symbolClass = "bg-orange-100 text-orange-600 border-orange-600";
                    timeoutDuration = 2000;
                    break;
            }

            // æ›´æ–° UI
            resultSymbol.classList.add(...symbolClass.split(' '));
            feedbackArea.innerHTML = `<span class="text-2xl">${message}</span>`;
            updateScoreDisplay(); // æ›´æ–°åˆ†æ•¸
            
            // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•
            setTimeout(() => {
                renderNextButton();
            }, timeoutDuration); 
        }
        
        /**
         * æ¸²æŸ“èµ·å§‹é é¢
         */
        function renderStartScreen() {
            player1Score = 0;
            player2Score = 0;
            // æ¯æ¬¡éŠæˆ²é–‹å§‹æ™‚ï¼Œé‡æ–°ç”Ÿæˆéš¨æ©Ÿé¡Œç›® (3 ç‰¹å®šè¦–è¦ºé¡Œ + 5 æ•¸å­—é¡Œ = 8 é¡Œ)
            questions = generateAllQuestions(); 
            
            // é¡¯ç¤ºåˆ†æ•¸é¡¯ç¤ºå…ƒç´ 
            document.getElementById('p1-score-display').classList.remove('hidden');
            document.getElementById('p2-score-display').classList.remove('hidden');

            appElement.innerHTML = `
                <div class="space-y-8 p-6 md:p-12 pt-12"> <!-- å¢åŠ  pt-12 è®“å…§å®¹é¿é–‹é ‚éƒ¨è¨ˆåˆ†æ¿ -->
                    <h1 class="text-5xl font-extrabold text-lime-700">å–®å…ƒ 8-3 åˆ†æ•¸çš„æ¯”å¤§å° PK æŒ‘æˆ°</h1>
                    <p class="text-2xl text-red-500 font-bold">é›™äºº PK æ¨¡å¼ï¼å…ˆç­”å°æˆ–åŒæ™‚ç­”å°è€…å¾—åˆ†ï¼</p>
                    <div class="flex flex-col md:flex-row justify-around text-left text-xl space-y-4 md:space-y-0">
                        <div class="bg-blue-100 p-4 rounded-lg shadow-inner border-l-4 border-blue-500 flex-1 mx-2">
                            <h3 class="font-bold text-blue-700">âš”ï¸ ç©å®¶ä¸€ (å·¦ä¸Š)</h3>
                            <p class="text-sm text-gray-600 mt-2">é»æ“Šè¢å¹•å·¦å´æŒ‰éˆ•ã€‚éŒ¯èª¤å°‡è¢«ç¦ç”¨è©²å›åˆã€‚</p>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li>æŒ‰éˆ•ï¼šå¤§æ–¼ (&gt;)</li>
                                <li>æŒ‰éˆ•ï¼šç­‰æ–¼ (=)</li>
                                <li>æŒ‰éˆ•ï¼šå°æ–¼ (&lt;)</li>
                            </ul>
                        </div>
                        <div class="bg-red-100 p-4 rounded-lg shadow-inner border-r-4 border-red-500 flex-1 mx-2">
                            <h3 class="font-bold text-red-700">ğŸ›¡ï¸ ç©å®¶äºŒ (å³ä¸Š)</h3>
                            <p class="text-sm text-gray-600 mt-2">é»æ“Šè¢å¹•å³å´æŒ‰éˆ•ã€‚éŒ¯èª¤å°‡è¢«ç¦ç”¨è©²å›åˆã€‚</p>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li>æŒ‰éˆ•ï¼šå¤§æ–¼ (&gt;)</li>
                                <li>æŒ‰éˆ•ï¼šç­‰æ–¼ (=)</li>
                                <li>æŒ‰éˆ•ï¼šå°æ–¼ (&lt;)</li>
                            </ul>
                        </div>
                    </div>
                    <button id="startButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105 text-2xl mt-8">
                        é–‹å§‹ PKï¼ (${questions.length} é¡ŒæŒ‘æˆ°)
                    </button>
                    <p class="text-sm text-gray-400 mt-6">
                        å°æç¤ºï¼šå‰ä¸‰é¡Œå°‡ä¾åºæ˜¯é•·æ–¹å½¢ã€åœ“å½¢ã€æ­£æ–¹å½¢åˆ†æ•¸åœ–å½¢çš„è¦–è¦ºè¼”åŠ©é¡Œï¼
                    </p>
                </div>
            `;
            document.getElementById('startButton').addEventListener('click', () => {
                currentQuestionIndex = 0;
                renderQuestion();
            });
            updateScoreDisplay(); // ç¢ºä¿åˆ†æ•¸é‡ç½®ç‚º 0
        }

        /**
         * æ¸²æŸ“é¡Œç›®é é¢
         */
        function renderQuestion() {
            if (currentQuestionIndex >= questions.length) {
                renderCompletionScreen();
                return;
            }
            
            // é‡ç½®æœ¬å›åˆçš„ç‹€æ…‹ã€é–å®šå’Œè¨ˆæ™‚å™¨
            isAnswerLocked = false; 
            if (roundTimeout) {
                clearTimeout(roundTimeout);
                roundTimeout = null;
            }
            currentQuestionState = { 
                p1_disabled: false, 
                p2_disabled: false, 
                correct_attempts: 0,
                first_winner: null,
            };


            const q = questions[currentQuestionIndex];
            const isVisual = q.type === 'visual';
            
            // ç¢ºä¿åˆ†æ•¸é¡¯ç¤ºå…ƒç´ å¯è¦‹
            document.getElementById('p1-score-display').classList.remove('hidden');
            document.getElementById('p2-score-display').classList.remove('hidden');
            
            let coreComparisonHTML = '';

            if (isVisual) {
                // åœ–å½¢å’Œåˆ†æ•¸å‚ç›´å°é½Šï¼Œç„¶å¾Œå…©çµ„ä¸¦æ’
                coreComparisonHTML = `
                    <div class="flex items-start justify-center space-x-4 md:space-x-12">
                        <!-- å·¦å´åˆ†æ•¸åŠåœ–å½¢ -->
                        <div class="flex flex-col items-center">
                            <div id="visual1" class="mb-4"></div>
                            ${createFractionHTML(q.n1, q.d1)}
                        </div>

                        <!-- æ¯”è¼ƒç¬¦è™Ÿ (èˆ‡åˆ†æ•¸ä¸­å¤®å°é½Š) -->
                        <div id="result-symbol" class="border-4 border-black bg-white h-16 w-16 flex items-center justify-center text-5xl font-extrabold text-gray-500 mt-20"></div>
                        
                        <!-- å³å´åˆ†æ•¸åŠåœ–å½¢ -->
                        <div class="flex flex-col items-center">
                            <div id="visual2" class="mb-4"></div>
                            ${createFractionHTML(q.n2, q.d2)}
                        </div>
                    </div>
                `;
            } else {
                // æ•¸å­—é¡Œç¶­æŒå–®è¡Œæ°´å¹³æ’åˆ—
                coreComparisonHTML = `
                    <div class="flex items-center justify-center space-x-2 md:space-x-6 h-28"> <!-- å¢åŠ é«˜åº¦ä¿æŒèˆ‡è¦–è¦ºé¡Œçš„è¦–è¦ºå¹³è¡¡ -->
                        ${createFractionHTML(q.n1, q.d1)}
                        <div id="result-symbol" class="border-4 border-black bg-white h-16 w-16 flex items-center justify-center text-5xl font-extrabold text-gray-500"></div>
                        ${createFractionHTML(q.n2, q.d2)}
                    </div>
                `;
            }


            appElement.innerHTML = `
                <div class="space-y-4 pt-12"> <!-- å¢åŠ  pt-12 é¿å…å…§å®¹è¢«é ‚éƒ¨è¨ˆåˆ†æ¿é®æ“‹ -->
                    <div class="text-xl font-semibold text-lime-600">PK æŒ‘æˆ° - ${q.title} (${currentQuestionIndex + 1}/${questions.length})</div>
                    <p class="text-3xl font-extrabold text-gray-800 mb-6">è«‹å¿«é€Ÿé¸æ“‡æ­£ç¢ºçš„æ¯”è¼ƒç¬¦è™Ÿï¼</p>
                    
                    <!-- é¡Œç›®ä¸»é«” -->
                    ${coreComparisonHTML}
                    
                    <!-- ç©å®¶æ“ä½œå€ï¼šå·¦å³ä¸¦æ’ -->
                    <div class="flex flex-row justify-between mt-8 md:mt-10 space-x-2">
                        <!-- ç©å®¶ä¸€æŒ‰éˆ• (å·¦) -->
                        <div id="p1-controls" class="flex flex-col space-y-3 p-4 bg-blue-50 rounded-lg border-2 border-blue-400 w-[49%]">
                            <h3 class="text-lg font-bold text-blue-700">ç©å®¶ä¸€</h3>
                            <!-- æŒ‰éˆ•é †åº: > , = , < -->
                            <button data-player="1" data-answer=">" onclick="checkAnswer(1, '>')" class="symbol-btn p1-btn text-4xl bg-blue-400 active:bg-blue-600 text-white font-extrabold py-3 rounded-xl shadow-md transition duration-150 transform active:scale-95"> &gt; </button>
                            <button data-player="1" data-answer="=" onclick="checkAnswer(1, '=')" class="symbol-btn p1-btn text-4xl bg-blue-400 active:bg-blue-600 text-white font-extrabold py-3 rounded-xl shadow-md transition duration-150 transform active:scale-95"> = </button>
                            <button data-player="1" data-answer="<" onclick="checkAnswer(1, '<')" class="symbol-btn p1-btn text-4xl bg-blue-400 active:bg-blue-600 text-white font-extrabold py-3 rounded-xl shadow-md transition duration-150 transform active:scale-95"> &lt; </button>
                        </div>

                        <!-- ç©å®¶äºŒæŒ‰éˆ• (å³) -->
                        <div id="p2-controls" class="flex flex-col space-y-3 p-4 bg-red-50 rounded-lg border-2 border-red-400 w-[49%]">
                            <h3 class="text-lg font-bold text-red-700">ç©å®¶äºŒ</h3>
                            <!-- æŒ‰éˆ•é †åº: > , = , < -->
                            <button data-player="2" data-answer=">" onclick="checkAnswer(2, '>')" class="symbol-btn p2-btn text-4xl bg-red-400 active:bg-red-600 text-white font-extrabold py-3 rounded-xl shadow-md transition duration-150 transform active:scale-95"> &gt; </button>
                            <button data-player="2" data-answer="=" onclick="checkAnswer(2, '=')" class="symbol-btn p2-btn text-4xl bg-red-400 active:bg-red-600 text-white font-extrabold py-3 rounded-xl shadow-md transition duration-150 transform active:scale-95"> = </button>
                            <button data-player="2" data-answer="<" onclick="checkAnswer(2, '<')" class="symbol-btn p2-btn text-4xl bg-red-400 active:bg-red-600 text-white font-extrabold py-3 rounded-xl shadow-md transition duration-150 transform active:scale-95"> &lt; </button>
                        </div>
                    </div>
                </div>
                <!-- å›é¥‹å€ -->
                <div id="feedback-area" class="mt-8 text-xl font-bold min-h-[4rem]"></div>
            `;
            
            // å¦‚æœæ˜¯è¦–è¦ºé¡Œï¼Œæ’å…¥åœ–å½¢
            if (isVisual) {
                document.getElementById('visual1').appendChild(createVisualModel(q.modelType, q.n1, q.d1));
                document.getElementById('visual2').appendChild(createVisualModel(q.modelType, q.n2, q.d2));
            }
        }

        /**
         * è™•ç†ç©å®¶çš„ç­”æ¡ˆ
         * @param {number} player ç©å®¶ç·¨è™Ÿ (1 æˆ– 2)
         * @param {string} answer ç©å®¶é¸æ“‡çš„ç¬¦è™Ÿ ('<', '=', '>')
         */
        function checkAnswer(player, answer) {
            if (isAnswerLocked) return;

            const q = questions[currentQuestionIndex];
            const feedbackArea = document.getElementById('feedback-area');
            const otherPlayer = player === 1 ? 'äºŒ' : 'ä¸€'; // ä¸­æ–‡ 'ä¸€' æˆ– 'äºŒ'
            
            // æª¢æŸ¥æ˜¯å¦å·²è¢«ç¦ç”¨ 
            if (player === 1 && currentQuestionState.p1_disabled) return;
            if (player === 2 && currentQuestionState.p2_disabled) return;

            if (answer === q.answer) {
                // --- ç­”å°é‚è¼¯ (Correct Answer) ---
                playCorrectSound(); 

                currentQuestionState.correct_attempts++;

                if (currentQuestionState.correct_attempts === 1) {
                    // ç¬¬ä¸€æ¬¡æ­£ç¢ºå›ç­” (é–‹å•Ÿ 50ms ç·©è¡çª—å£)
                    currentQuestionState.first_winner = player;
                    
                    // è¨­ç½®è¨ˆæ™‚å™¨ï¼Œå¦‚æœ 50ms å¾Œæ²’æœ‰ç¬¬äºŒå€‹æ­£ç¢ºç­”æ¡ˆï¼Œå‰‡åˆ¤å®šç‚ºå–®äººå‹å‡º
                    roundTimeout = setTimeout(() => {
                        finalizeRound('single_winner');
                    }, 50);

                    const color = player === 1 ? 'blue' : 'red';
                    feedbackArea.innerHTML = `<span class="text-xl text-${color}-600">ç©å®¶${player}å·²æ¶ç­”æˆåŠŸï¼ç­‰å¾…å°æ‰‹å›æ‡‰...</span>`;

                } else if (currentQuestionState.correct_attempts === 2) {
                    // ç¬¬äºŒæ¬¡æ­£ç¢ºå›ç­” (åœ¨ 50ms ç·©è¡çª—å£å…§)ï¼Œåˆ¤å®šç‚ºé›™äººåŒæ™‚ç­”å°
                    finalizeRound('simultaneous');
                }

            } else {
                // --- ç­”éŒ¯é‚è¼¯ (Wrong Answer / Penalty) ---
                playWrongSound(); 
                
                // ç¦ç”¨ç•¶å‰ç©å®¶çš„æ§åˆ¶å€
                if (player === 1) {
                    currentQuestionState.p1_disabled = true;
                    disablePlayerButtons(1);
                } else {
                    currentQuestionState.p2_disabled = true;
                    disablePlayerButtons(2);
                }

                // ç­”éŒ¯çš„æŒ‰éˆ•çŸ­æš«è®Šç´…ä¸¦ç½®ç°
                const wrongBtn = document.querySelector(`#p${player}-controls button[data-answer="${answer}"]`);
                wrongBtn.classList.remove(`bg-${player === 1 ? 'blue' : 'red'}-400`);
                wrongBtn.classList.add('bg-red-700');


                // æª¢æŸ¥æ˜¯å¦å…©ä½ç©å®¶éƒ½å¤±æ•—äº†
                if (currentQuestionState.p1_disabled && currentQuestionState.p2_disabled) {
                    // é›™æ–¹éƒ½å¤±æ•—ï¼Œå›åˆçµæŸ
                    finalizeRound('double_fault');

                } else {
                    // åªæœ‰ä¸€å€‹ç©å®¶å¤±æ•—ï¼Œå¦ä¸€å€‹ç©å®¶ä»å¯ä½œç­”
                    // æª¢æŸ¥æ˜¯å¦æœ‰ pending çš„ single_winner è¨ˆæ™‚å™¨ã€‚å¦‚æœæœ‰ï¼Œå‰‡å–æ¶ˆå®ƒï¼Œå› ç‚ºç¾åœ¨å¦ä¸€æ–¹å·²ç¶“å¤±æ•—ï¼Œå–®äººå‹å‡ºç¢ºå®šã€‚
                    if (roundTimeout && currentQuestionState.correct_attempts === 1) {
                        finalizeRound('single_winner'); // ç¬¬ä¸€ä½ç­”å°è€…å‹å‡º
                        return;
                    }

                    // åƒ…é¡¯ç¤ºæ‡²ç½°è¨Šæ¯
                    feedbackArea.innerHTML = `<span class="text-xl text-red-500">é€™é¡Œå¥½åƒæ˜¯å…¶ä»–ç­”æ¡ˆï¼Œè«‹ç©å®¶${otherPlayer}ç¹¼çºŒä½œç­”ï¼</span>`;
                }
            }
        }

        /**
         * æ¸²æŸ“ä¸‹ä¸€é¡Œæˆ–çµæŸæŒ‰éˆ•
         */
        function renderNextButton() {
            const feedbackArea = document.getElementById('feedback-area');
            const nextButton = document.createElement('button');
            nextButton.id = 'nextButton';
            nextButton.className = 'mt-4 font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 transform hover:scale-105 text-xl bg-lime-500 text-white hover:bg-lime-600';

            if (currentQuestionIndex + 1 >= questions.length) {
                // æœ€çµ‚é¡Œé‚è¼¯
                nextButton.textContent = "æŸ¥çœ‹çµæœ ğŸ‰";
                nextButton.classList.remove('bg-lime-500', 'hover:bg-lime-600');
                nextButton.classList.add('bg-purple-600', 'hover:bg-purple-700'); 
                
                nextButton.onclick = () => {
                    currentQuestionIndex++; 
                    renderCompletionScreen(); 
                };
            } else {
                // æ¸²æŸ“ä¸‹ä¸€é¡Œ
                nextButton.textContent = "ä¸‹ä¸€é¡Œ >>";
                nextButton.onclick = () => {
                    currentQuestionIndex++;
                    renderQuestion();
                };
            }

            // æ¸…é™¤å›é¥‹å€ä¸¦æ’å…¥æŒ‰éˆ•
            feedbackArea.innerHTML = '';
            feedbackArea.appendChild(nextButton);
        }

        /**
         * æ¸²æŸ“éŠæˆ²çµæŸé é¢ 
         */
        function renderCompletionScreen() {
            
            // ç¢ºä¿åˆ†æ•¸é¡¯ç¤ºå…ƒç´ éš±è—
            document.getElementById('p1-score-display').classList.add('hidden');
            document.getElementById('p2-score-display').classList.add('hidden');

            let winnerText = '';
            let winnerColor = 'text-gray-600';

            if (player1Score > player2Score) {
                winnerText = 'ç©å®¶ä¸€ç²å‹ï¼æ­å–œæ‚¨æˆç‚ºåˆ†æ•¸å¤§å¸«ï¼ğŸ†';
                winnerColor = 'text-blue-600';
            } else if (player2Score > player1Score) {
                winnerText = 'ç©å®¶äºŒç²å‹ï¼æ­å–œæ‚¨æˆç‚ºåˆ†æ•¸å¤§å¸«ï¼ğŸ†';
                winnerColor = 'text-red-600';
            } else {
                winnerText = 'å¹³æ‰‹ï¼é›™æ–¹éƒ½éå¸¸å²å®³ï¼ğŸ¤';
                winnerColor = 'text-yellow-600';
            }

            appElement.innerHTML = `
                <div class="space-y-8 p-6 md:p-12">
                    <h1 class="text-6xl font-extrabold text-lime-700">éŠæˆ²çµæŸï¼</h1>
                    
                    <div class="p-6 rounded-xl shadow-lg border-4 ${winnerColor.replace('text-', 'border-')} bg-white">
                        <p class="text-4xl font-bold mb-4 ${winnerColor}">${winnerText}</p>
                        <div class="flex justify-center space-x-12 text-2xl font-semibold">
                            <div class="text-blue-600">ç©å®¶ä¸€å¾—åˆ†ï¼š<span class="text-5xl font-extrabold">${player1Score}</span></div>
                            <div class="text-red-600">ç©å®¶äºŒå¾—åˆ†ï¼š<span class="text-5xl font-extrabold">${player2Score}</span></div>
                        </div>
                    </div>

                    <button id="restartButton" onclick="renderStartScreen()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-10 rounded-full shadow-lg transition duration-300 transform hover:scale-105 text-2xl mt-8">
                        å†ç©ä¸€æ¬¡ï¼
                    </button>
                    
                </div>
            `;
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œåˆå§‹åŒ–
        window.onload = () => {
            renderStartScreen();
        };
    </script>
</body>
</html>
